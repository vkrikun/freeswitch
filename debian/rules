#!/usr/bin/make -f
# -*- makefile -*-
#export DH_VERBOSE=1

DEFS=
DEFS+=-DSWITCH_MOD_DIR=/usr/lib/freeswitch/mod
DEFS+=-DSWITCH_CONF_DIR=/etc/freeswitch
DEFS+=-DSWITCH_LOG_DIR=/var/log/freeswitch
DEFS+=-DSWITCH_RUN_DIR=/var/run/freeswitch
DEFS+=-DSWITCH_RECORDINGS_DIR=/var/lib/freeswitch/recordings
DEFS+=-DSWITCH_SOUNDS_DIR=/usr/share/freeswitch/sounds
DEFS+=-DSWITCH_STORAGE_DIR=/var/lib/freeswitch/storage
DEFS+=-DSWITCH_DB_DIR=/var/lib/freeswitch/db
DEFS+=-DSWITCH_SCRIPT_DIR=/usr/share/freeswitch/scripts
DEFS+=-DSWITCH_HTDOCS_DIR=/usr/share/freeswitch/htdocs
DEFS+=-DSWITCH_GRAMMAR_DIR=/usr/share/freeswitch/grammar
DEFS+=-DSWITCH_TEMP_DIR=/tmp
export CFLAGS=-ggdb3 -O2 $(DEFS)
export CXXFLAGS=-ggdb3 -O2 $(DEFS)

.PHONY: binary-quicktest

override_dh_auto_clean:
	dh_clean

.stamp-bootstrap:
	./bootstrap.sh -j
	touch $@

.stamp-configure: .stamp-bootstrap
	./configure -C --enable-portable-binary --disable-dependency-tracking \
		--host=$(DEB_HOST_GNU_TYPE) --build=$(DEB_BUILD_GNU_TYPE) \
		--with-gnu-ld --with-python --with-erlang --with-openssl \
		--enable-core-odbc-support --enable-zrtp \
		--prefix=/usr --localstatedir=/var \
		--sysconfdir=/etc/freeswitch \
		--with-modinstdir=/usr/lib/freeswitch/mod \
		--with-rundir=/var/run/freeswitch \
		--with-logfiledir=/var/log/freeswitch \
		--with-dbdir=/var/lib/freeswitch/db \
		--with-htdocsdir=/usr/share/freeswitch/htdocs \
		--with-soundsdir=/usr/share/freeswitch/sounds \
		--with-grammardir=/usr/share/freeswitch/grammar \
		--with-scriptdir=/usr/share/freeswitch/scripts \
		--with-recordingsdir=/var/lib/freeswitch/recordings
	touch $@

override_dh_auto_configure: .stamp-configure

.stamp-build: .stamp-configure
	make -j
	touch $@

override_dh_auto_build: .stamp-build

override_dh_auto_test:

override_dh_strip:
	dh_strip -a -k
	./debian/create-dbg-pkgs.sh

override_dh_auto_install:
	dh_auto_install
	DESTDIR=debian/tmp make cd-sounds-install cd-moh-install

override_dh_installinit:
	dh_installinit -pfreeswitch-sysvinit --name=freeswitch

%:
	dh $@

binary-quicktest:
	echo "applications/mod_commands" > debian/modules.conf
	(cd debian && ./bootstrap.sh)
	dh binary -Nfreeswitch-sounds-music -Nfreeswitch-sounds-en-us -Nfreeswitch-sounds-en-us-callie

